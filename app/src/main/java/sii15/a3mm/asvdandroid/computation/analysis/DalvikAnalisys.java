package sii15.a3MM.ASVDAndroid.computation.analysis;

import org.jf.baksmali.*;

import sii15.a3MM.ASVDAndroid.computation.util.Const;
import sii15.a3MM.ASVDAndroid.computation.util.ListManager;
import sii15.a3MM.ASVDAndroid.computation.util.SmaliManager;
import sii15.a3MM.ASVDAndroid.computation.util.*;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

/**
 * 
 * @author Simone Martucci
 * @author Mattia Mancini
 *
 * Class used decompile dex file to smali files
 * and then analyze every one to search errors
 */

public class DalvikAnalisys {
	
	private String directory = null; 
	private boolean tmpDir = true;
	private File root = null;
	private List<File> filelist = new ArrayList<File>();
	
	public DalvikAnalisys(File dexClass, String packageName, String decompilerDir) throws IOException {
		//Set the correct directory to store the bytecode
		if(decompilerDir == null) 
			directory = System.getProperty("java.io.tmpdir")+ File.separator + "smali" + File.separator + packageName; 
		else {
			directory = decompilerDir + File.separator + packageName; 
			tmpDir = false;
		}
		root = new File(directory);
		//Start baksmali tool, convert dex that is not readable to smali, that is readable
		String[] smaliArgs = {"-o", directory, dexClass.getPath().toString()};
		main.main(smaliArgs);
		
	}
	
	/**
	 * This function is the core of all project
	 * Begin analysis of every smali file previously
	 * created and set the upper variable in case a 
	 */
	public void checkVulnerabilities(ErrorLists el) {
		//new analyzer will be created, need to check every file
		Analyzer analyzer = new Analyzer();
		//obtaining smali file list
		SmaliManager.getSmaliFileList(root, filelist);
		for (File file : filelist) {
			try {
				//buffered reader to read file one line at a time
				BufferedReader reader = new BufferedReader(new FileReader(file));
				String line;
				//array of boolean to avoid looking for the same vulnerability in a file many times 
				boolean[] checked = {false, false, false, false};
				//begin reading file
				while ((line = reader.readLine()) != null) {
					if(line.contains(Const.SERVER_FUNCTION) && line.contains(Const.METHOD) && !checked[0]) {
						checked[0] = true;
						el.setTmClass(file.getPath());
						if(analyzer.checkIfInvoked(file.getPath().substring(directory.length() + 1, file.getPath().length() - Const.SMALI.length()), filelist)) {
							el.setTmVulnerability(analyzer.searchTmVulnerabilities(reader));
						}
						else {
							el.setTmVulnerability(analyzer.searchTmVulnerabilities(reader) + Const.NEVER_INVOKED);
						}
					}
					else if(line.contains(Const.METHOD) && line.contains(Const.VERIFY) && line.contains(Const.SSL_SESSION) && !checked[1]) {
						checked[1] = true;
						el.setHnClass(file.getPath());
						if(analyzer.checkIfInvoked(file.getPath().substring(directory.length() + 1, file.getPath().length() - Const.SMALI.length()), filelist)) {
							el.setHnVulnerability(analyzer.searchHnVulnerabilities(reader));
						}
						else {
							el.setHnVulnerability(analyzer.searchHnVulnerabilities(reader) + Const.NEVER_INVOKED);
						}
					}
					else if(line.contains(Const.METHOD) && line.contains(Const.SSL_FUNCTION) && !checked[2]) {
						checked[2] = true;
						el.setSslhandleClass(file.getPath());
						el.setSslhandleVulnerability(analyzer.searchSslErrorVulnerabilities(reader));
					}
					else if((line.contains(Const.ALLOW_HOSTNAME) || line.contains(Const.ALLOW_ALL)) && !checked[3]) {
						checked[3] = true;
						if(line.contains(Const.INSTANCE) || line.contains(Const.SGET_OBJ))
							el.setAllowedHnVerifier(file.getPath());
					}
				}
				reader.close();
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		//modify list to get a more user friendly ouptut
		ListManager.modifyPaths(el.getTmClass(), directory);
		ListManager.modifyPaths(el.getHnClass(), directory);
		ListManager.modifyPaths(el.getSslhandleClass(), directory);
		ListManager.modifyPaths(el.getAllowedHnVerifier(), directory);
		//remove files if not specified otherwise
		if(tmpDir) SmaliManager.removeTmpFile(filelist, root);
	}

}
