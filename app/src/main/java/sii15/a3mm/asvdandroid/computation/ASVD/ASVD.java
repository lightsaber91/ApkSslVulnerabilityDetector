package sii15.a3MM.ASVDAndroid.computation.ASVD;

import java.io.IOException;
import javax.xml.parsers.ParserConfigurationException;
import sii15.a3MM.ASVDAndroid.computation.malScanner.mScanner;
import org.xml.sax.SAXException;
import org.xmlpull.v1.XmlPullParserException;
import sii15.a3MM.ASVDAndroid.computation.util.Printer;
import sii15.a3MM.ASVDAndroid.computation.analysis.*;
/**
 * 
 * @author Simone Martucci
 * @author Mattia Mancini
 * 
 */
public final class ASVD {
	/**
	 * @param apkName: name of the file, read from command line
	 * @param xmlOutput: if true output will be formatted with xml syntax
	 * @param decompilerDirectory: directory where to store bytecode for analysis
	 * @param bytecode: object containing bytecode
	 * @param showOnlyApkInfo: print just package name and version
	 * @param scanMalware: if true scan the app searching for malaware
	 */
	private static boolean xmlOutput = false;
	private static boolean scanMalware = true;
	private static boolean showOnlyApkInfo = false;
	private static String apkName = null;
	private static String decompilerDirectory = null;
	private static DalvikAnalisys bytecode = null;
	
	public static void main(String[] args) throws IOException, ParserConfigurationException, SAXException, XmlPullParserException {
		//read passed arguments
		parseArgs(args);
		if (apkName == null) {
			//print help
			Printer.printHelp();
		}
		
		if(scanMalware) mScanner.newInstance();
		
		//create new apk file
		APK file = new APK(apkName);
				
		System.out.println("Analize file: " + apkName);
		System.out.println("Package: " + file.getPackage() + ", Version: " + file.getVersion());
		//check file permission
		if(!file.getPermssion()) {
			//if file does not require internet access do not continue analysis
			System.out.println("App does not require INTERNET permission. No need to worry about SSL misuse... Abort!\n");
			file.close();
			//System.exit(0);
			return;
		}
		if(showOnlyApkInfo) {
			file.close();
			//System.exit(0);
			return;
		}
		//internet permission found so continue analysis
		System.out.println("INTERNET permission found, continue analysis...");
		System.out.println("Decompiling DEX file...");
	
		//new dex file will be created to read the bytecode correctly
		bytecode = new DalvikAnalisys(file.getDexFile(), file.getPackage(), decompilerDirectory);
		System.out.println("Decompilation of DEX file finished");
		
		//beginning of real analysis on the dex file
		long startTime = System.currentTimeMillis();
		System.out.println("Beginning of analisys");
		bytecode.checkVulnerabilities();
			
		if(scanMalware) {
			//Beginning of scan
			//TODO
			mScanner.getInstance().scanDex();
		}
		
		double estimatedTime = (double) (System.currentTimeMillis() - startTime) / 1000;
		System.out.println("Apk analisys complete in " + estimatedTime +" seconds!\n");
		
		if(xmlOutput) {
			//Print output in xml file
			Printer.printXml(file.getPackage(), file.getVersion(), decompilerDirectory);
		}
		else {
			//print normal output
			Printer.printConclusion();
		}
		
		//close apk then exit
		file.close();
		System.out.println("Exiting...");
		//System.exit(0);
		return;
	}
	
	/**
	 * Utility to read the arguments in the correct way
	 * @param args : arguments passed
	 */
	private static void parseArgs(String[] args) {
		
		for(int i = 0; i < args.length; i++) {
			if(args[i].compareTo("-h") == 0 || args[i].compareTo("--help") == 0) {
				Printer.printHelp();
			}
			else if(args[i].compareTo("-x") == 0 || args[i].compareTo("--xml") == 0) xmlOutput = true;
			else if(args[i].compareTo("-d") == 0 || args[i].compareTo("--dir") == 0) {
				if(i < args.length -1 && !args[i+1].startsWith("-"))
					decompilerDirectory = args[i+1];
			}
			else if(args[i].compareTo("-f") == 0 || args[i].compareTo("--file") == 0) {
				if(i < args.length -1 && !args[i+1].startsWith("-"))
					apkName = args[i+1];
			}
			else if(args[i].compareTo("-i") == 0 || args[i].compareTo("--info") == 0) showOnlyApkInfo = true;
			else if(args[i].compareTo("-s") == 0 || args[i].compareTo("--scan") == 0) scanMalware = true;
				
		}
		
	}


}
