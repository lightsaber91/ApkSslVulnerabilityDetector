package sii15.a3MM.ASVDAndroid.asynctask;

import android.os.AsyncTask;
import android.support.v4.app.FragmentActivity;

import com.gc.materialdesign.widgets.ProgressDialog;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.SAXException;
import org.xmlpull.v1.XmlPullParserException;

import java.io.File;
import java.io.IOException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;

import sii15.a3MM.ASVDAndroid.activity.ResultsFragment;
import sii15.a3MM.ASVDAndroid.computation.ASVD.ASVD;
import sii15.a3MM.ASVDAndroid.utils.AllowAllHostnameError;
import sii15.a3MM.ASVDAndroid.utils.Apk;
import sii15.a3MM.ASVDAndroid.utils.HostnameVerifierError;
import sii15.a3MM.ASVDAndroid.utils.SslHandlerError;
import sii15.a3MM.ASVDAndroid.utils.TrustManagerError;

/**
 * Created by Mattia on 18/06/2015.
 */
public class ScanApp extends AsyncTask<Void, Void, Void> {

    private FragmentActivity activity;
    private ProgressDialog loading;
    private String p;
    private String n;
    private Apk app;

    public ScanApp(FragmentActivity fragmentActivity, String path, String name, Apk a) {
        activity = fragmentActivity;
        p = path;
        n = name;
        app = a;
    }

    @Override
    protected void onPreExecute() {
        loading = new ProgressDialog(activity, "Scanning the selected APK...");
        loading.show();
    }

    @Override
    protected Void doInBackground(Void... params) {
        try {
            ASVD.main(new String[]{"-f", p, "-s", "-x", n});
            parseXmlResult(n);
        } catch (IOException e) {
            e.printStackTrace();
        } catch (ParserConfigurationException e) {
            e.printStackTrace();
        } catch (SAXException e) {
            e.printStackTrace();
        } catch (XmlPullParserException e) {
            e.printStackTrace();
        }
        return null;
    }

    @Override
    protected void onPostExecute(Void v) {
        loading.dismiss();
        ResultsFragment.createView();
    }

    private boolean parseXmlResult(String name) throws ParserConfigurationException, SAXException, IOException {
        File fXmlFile = new File(System.getProperty("java.io.tmpdir") + File.separator + name + ".xml");
        //se il file non esiste la scansione Ã¨ fallita
        if(!fXmlFile.exists()) return false;
        DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
        DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
        Document doc = dBuilder.parse(fXmlFile);

        //optional, but recommended
        doc.getDocumentElement().normalize();
        //parsing package and version of app
        app.setPackageName(doc.getDocumentElement().getAttribute("package"));
        app.setPackageVersion(doc.getDocumentElement().getAttribute("version"));

        //trust manager vulnerabilities
        NodeList tm = doc.getElementsByTagName("TrustManagers");
        NodeList tmchilds = tm.item(0).getChildNodes();
        for(int tmp = 0; tmp < tmchilds.getLength(); tmp++) {
            Node node = tmchilds.item(tmp);
            if (node.getNodeType() == Node.ELEMENT_NODE) {
                Element el = (Element) node;
                TrustManagerError tmptm = new TrustManagerError();
                tmptm.setClasses(el.getAttribute("class"));
                tmptm.setVuln(el.getAttribute("status"));
                app.addTME(tmptm);
            }
        }

        //hostname verifier
        NodeList hn = doc.getElementsByTagName("HostnameVerifiers");
        NodeList hnchilds = hn.item(0).getChildNodes();
        for(int tmp = 0; tmp < hnchilds.getLength(); tmp++) {
            Node node = hnchilds.item(tmp);
            if (node.getNodeType() == Node.ELEMENT_NODE) {
                Element el = (Element) node;
                if(el.getTagName().equals("allowAllHostnames")) {
                    AllowAllHostnameError al = new AllowAllHostnameError();
                    al.setClasses(el.getAttribute("class"));
                    app.addAAE(al);
                }
                else {
                    HostnameVerifierError hv = new HostnameVerifierError();
                    hv.setClasses(el.getAttribute("class"));
                    hv.setVuln(el.getAttribute("status"));
                    app.addHVE(hv);
                }
            }
        }
        NodeList ssl = doc.getElementsByTagName("SslHandlerErrors");
        NodeList sslchilds = ssl.item(0).getChildNodes();
        for(int tmp = 0; tmp < sslchilds.getLength(); tmp++) {
            Node node = sslchilds.item(tmp);
            if (node.getNodeType() == Node.ELEMENT_NODE) {
                Element el = (Element) node;
                SslHandlerError se = new SslHandlerError();
                se.setClasses(el.getAttribute("class"));
                se.setVuln(el.getAttribute("status"));
                app.addSSLE(se);
            }
        }
        return true;
    }
}
